# 测试指南

<cite>
**本文档引用的文件**
- [test_numerical_stability.py](file://test_numerical_stability.py)
- [enhance_numerical_stability.py](file://enhance_numerical_stability.py)
- [comprehensive_parameter_check.py](file://comprehensive_parameter_check.py)
- [verify_node_adjustment.py](file://verify_node_adjustment.py)
- [vec_system_config.json](file://vec_system_config.json)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构与测试目录](#项目结构与测试目录)
3. [核心测试模块详解](#核心测试模块详解)
4. [数值稳定性测试指南](#数值稳定性测试指南)
5. [系统级验证工具](#系统级验证工具)
6. [常见测试失败场景排查](#常见测试失败场景排查)
7. [测试可靠性增强建议](#测试可靠性增强建议)
8. [结论](#结论)

## 引言
本测试指南旨在为VEC_mig_caching系统提供全面的测试方法论，涵盖单元测试、集成测试和数值稳定性验证。文档重点介绍如何在`tests/`目录中编写和运行测试用例，以验证核心模块（如算法、决策、缓存）的正确性。特别强调`test_numerical_stability.py`的使用方法，用于检测梯度消失或爆炸等数值问题，并结合`enhance_numerical_stability.py`进行调试。同时，文档将阐述`comprehensive_parameter_check.py`和`verify_node_adjustment.py`在系统级验证中的关键作用，为开发者提供一套完整的测试与验证解决方案。

## 项目结构与测试目录
本项目采用模块化设计，主要功能模块包括算法（algorithms）、缓存（caching）、决策（decision）、迁移（migration）等。测试相关脚本位于项目根目录，而非传统的`tests/`子目录中，这表明测试脚本是作为独立的验证工具而非单元测试套件存在。

核心测试与验证脚本包括：
- `test_numerical_stability.py`：数值稳定性验证测试
- `comprehensive_parameter_check.py`：全面参数检查
- `verify_node_adjustment.py`：节点数量调整验证
- `enhance_numerical_stability.py`：数值稳定性增强工具

这些脚本通过导入系统核心模块（如`config`、`utils`）来访问配置和工具函数，对系统进行端到端的验证。

**Section sources**
- [test_numerical_stability.py](file://test_numerical_stability.py#L1-L20)
- [comprehensive_parameter_check.py](file://comprehensive_parameter_check.py#L1-L20)
- [verify_node_adjustment.py](file://verify_node_adjustment.py#L1-L20)

## 核心测试模块详解
系统的核心测试模块围绕数值稳定性、参数一致性和系统性能展开。`test_numerical_stability.py`负责验证关键计算的鲁棒性，`comprehensive_parameter_check.py`确保配置的正确性，而`verify_node_adjustment.py`则评估特定网络配置下的系统表现。

这些模块共同构成了一个多层次的验证体系，从底层计算到高层系统配置，确保了整个仿真系统的可靠性和准确性。

## 数值稳定性测试指南

### test_numerical_stability.py 的使用方法
`test_numerical_stability.py` 是一个关键的诊断工具，用于检测系统中潜在的数值问题，如梯度消失、梯度爆炸、除零错误和浮点溢出。

**运行方法**：
```bash
python test_numerical_stability.py
```

**测试内容**：
该脚本执行三项核心测试：
1.  **边界情况测试**：验证系统在极端输入下的行为，如除零、负数平方根、NaN和无穷大值。
2.  **系统计算测试**：模拟各种任务场景（极小/极大任务、低/高频处理），检查处理能力、负载因子等关键指标的计算稳定性。
3.  **能耗计算测试**：测试车辆能耗模型在不同CPU频率和利用率下的计算稳定性。

**输出解读**：
- **通过**：所有测试通过，输出“🎉 所有数值稳定性测试通过！”和“💡 系统数值稳定性良好，可以安全运行”。
- **失败**：部分测试失败，输出“⚠️ 部分测试未通过，建议检查相关代码”和“🔧 建议使用数值稳定性工具模块进行修复”。

当测试失败时，应立即使用`enhance_numerical_stability.py`进行修复。

### enhance_numerical_stability.py 的调试与增强
`enhance_numerical_stability.py` 是一个修复工具，它通过创建`utils/numerical_stability.py`模块来增强系统的数值稳定性。

**运行方法**：
```bash
python enhance_numerical_stability.py
```

**功能**：
1.  **创建稳定性工具模块**：生成`utils/numerical_stability.py`，提供一系列安全函数：
    - `safe_divide()`: 安全除法，避免除零。
    - `safe_sqrt()`: 安全平方根，避免负数输入。
    - `validate_energy()`, `validate_delay()`: 验证并修正能耗和延迟值。
    - `clamp()`: 将数值限制在安全范围内。
    - `check_numerical_health()`: 检查数值是否健康（非NaN、非Inf、不过大）。
2.  **创建验证测试**：重新生成`test_numerical_stability.py`，使其依赖新的工具模块。

**调试流程**：
1.  运行 `test_numerical_stability.py` 发现数值问题。
2.  运行 `enhance_numerical_stability.py` 修复问题。
3.  再次运行 `test_numerical_stability.py` 验证修复效果。

**Section sources**
- [test_numerical_stability.py](file://test_numerical_stability.py#L40-L185)
- [enhance_numerical_stability.py](file://enhance_numerical_stability.py#L50-L542)

## 系统级验证工具

### comprehensive_parameter_check.py 的作用
`comprehensive_parameter_check.py` 是一个全面的系统健康检查工具，用于验证系统配置的正确性和一致性。

**核心检查项**：
- **参数一致性**：对比`vec_system_config.json`外部配置文件与`config.system_config`内部配置，确保两者同步。
- **内存规范符合性**：检查任务参数（到达率、数据大小、计算密度）是否符合预设的内存规范。
- **UAV能耗参数完整性**：验证`uav_kappa3`等关键UAV能耗参数是否存在。
- **数值稳定性**：检查配置参数是否可能导致数值问题（如分母为零）。
- **通信参数**：验证总带宽、发射功率等是否符合规范。
- **计算逻辑**：验证处理能力、负载因子等核心计算公式的正确性。

**运行与输出**：
运行此脚本会生成一份详细的报告，列出所有发现的问题和修复建议。如果所有检查通过，将输出“✅ 所有检查通过，系统参数配置正确！”和“🎉 全面检查完成，系统状态良好！”，表明系统可以安全运行。

### verify_node_adjustment.py 的作用
`verify_node_adjustment.py` 专门用于评估特定网络拓扑配置的合理性，特别是验证从“40车辆+14RSU+4UAV”调整为“12车辆+6RSU+2UAV”的效果。

**核心分析项**：
- **论文符合性**：检查UAV数量是否为2，符合论文设定。
- **系统容量**：计算车辆、RSU、UAV的总处理能力，并与任务生成率比较，得出系统负载因子。
- **通信需求**：估算上传/下载数据量和总通信需求，计算带宽利用率。

**综合评估**：
脚本会根据论文符合性、系统容量平衡和通信效率三项指标进行评分。理想情况下，系统负载因子应在0.3-0.8之间，带宽利用率应≤70%。最终输出调整总结，判断配置是否成功。

**Section sources**
- [comprehensive_parameter_check.py](file://comprehensive_parameter_check.py#L40-L360)
- [verify_node_adjustment.py](file://verify_node_adjustment.py#L40-L284)

## 常见测试失败场景排查
当测试失败时，应根据错误信息进行针对性排查。

### 状态更新异常
- **现象**：系统状态（如节点位置、任务队列）未按预期更新。
- **排查**：
  1.  检查`models/`目录下的节点类（`vehicle_node.py`, `uav_node.py`）的状态更新逻辑。
  2.  确认`enhanced_vehicle_mobility.py`中的移动模型是否正确调用。
  3.  使用`comprehensive_parameter_check.py`检查`time_slot_duration`等时间参数是否合理。

### 奖励计算偏差
- **现象**：强化学习算法的奖励值异常，导致训练不稳定。
- **排查**：
  1.  检查`utils/reward_calculator.py`中的奖励计算公式。
  2.  使用`test_numerical_stability.py`验证计算中是否存在数值不稳定（如除零、溢出）。
  3.  确认`standardized_reward.py`是否正确应用了标准化。

### 动作空间越界
- **现象**：智能体输出的动作值超出了`uav_action_space.py`定义的范围。
- **排查**：
  1.  检查`algorithms/`目录下各算法（如MADDPG, MATD3）的输出层和动作选择逻辑。
  2.  确认是否在动作应用前使用了`clamp()`函数进行限制。
  3.  使用`comprehensive_parameter_check.py`检查动作空间的配置参数。

**Section sources**
- [comprehensive_parameter_check.py](file://comprehensive_parameter_check.py#L40-L360)
- [test_numerical_stability.py](file://test_numerical_stability.py#L40-L185)
- [algorithms/uav_action_space.py](file://algorithms/uav_action_space.py)

## 测试可靠性增强建议
为了提高测试的可靠性和可维护性，建议采用以下方法：

1.  **断言与日志结合**：
    - 在关键计算路径中使用`assert`语句进行前置条件检查。
    - 结合`utils/logger.py`进行详细日志记录，特别是在`check_numerical_health()`函数中，它会打印出NaN、Inf等异常值的警告。
    - 例如，在计算能耗前，先断言频率和利用率在合理范围内。

2.  **利用现有工具模块**：
    - 在所有除法运算中优先使用`safe_divide()`。
    - 对所有输入参数使用`validate_*`系列函数进行校验。
    - 使用`clamp()`函数保护所有可能溢出的计算。

3.  **定期运行全面检查**：
    - 在每次修改配置或核心算法后，都应运行`comprehensive_parameter_check.py`和`test_numerical_stability.py`。
    - 将`verify_node_adjustment.py`作为评估新网络配置的标准流程。

**Section sources**
- [utils/numerical_stability.py](file://utils/numerical_stability.py)
- [utils/logger.py](file://utils/logger.py)

## 结论
本指南详细介绍了VEC_mig_caching系统的测试与验证体系。通过`test_numerical_stability.py`和`enhance_numerical_stability.py`可以有效解决数值稳定性问题；通过`comprehensive_parameter_check.py`和`verify_node_adjustment.py`可以确保系统配置的正确性和合理性。开发者应遵循本指南，结合断言和日志，建立健壮的测试流程，以保障系统仿真实验的准确性和可靠性。